# ä¼ä¸šçº§å‘åŒ…æµç¨‹

## èƒŒæ™¯

åœ¨ä¼ä¸šçº§é¡¹ç›®ä¸­ï¼Œå‘åŒ…å¾ˆå¸¸è§ï¼Œå®ƒå¯èƒ½æ˜¯ä¸€ä¸ªåŸºç¡€åŒ…æˆ–æ˜¯æŸä¸ªåŠŸèƒ½æ’ä»¶ï¼Œä½†éƒ½é¿å…ä¸äº†æ–°å¢åŠŸèƒ½æˆ–è€… `bugfix`ï¼Œè¿™å°±æ¶‰åŠåˆ°å¦‚ä½•å¿«é€Ÿå‘å¸ƒæµ‹è¯•åŒ…ä»¥åŠæ­£å¼åŒ…ã€‚æœ¬æ–‡ä¸»è¦ä»‹ç»ä¸€ç§é€šç”¨çš„å‘åŒ…æµç¨‹ï¼Œå¯ä»¥æ»¡è¶³å¤§éƒ¨åˆ†åœºæ™¯ã€‚

## å‰è¨€

æœ¬æ–‡è¯¦ç»†ä»‹ç» Monorepo é¡¹ç›®çš„å‘åŒ…æµç¨‹å’Œæ“ä½œæ­¥éª¤ã€‚ä¸»è¦åŸºäº [changesets](https://github.com/changesets/changesets) å®ç°ã€‚
**å•ä»“åº“ä¹Ÿé€‚ç”¨äºæœ¬æ–¹æ¡ˆ**

## å‘åŒ…ç±»å‹

é¡¹ç›®æ”¯æŒä¸¤ç§å‘åŒ…ç±»å‹ï¼š

- å¿«ç…§åŒ…å‘åŒ…
- æ­£å¼åŒ…å‘åŒ…

### å¿«ç…§åŒ…å‘åŒ…

å¿«ç…§åŒ…æ˜¯æŒ‡å‘åŒ…çš„åŒ…æ˜¯ `beta` ç‰ˆæœ¬ï¼Œä½¿ç”¨åœºæ™¯ä¸»è¦æ˜¯å¼€å‘ã€æµ‹è¯•é˜¶æ®µï¼Œå¯ä»¥å¿«é€ŸéªŒè¯åŠŸèƒ½æ˜¯å¦æ­£å¸¸ï¼Œä¸æ˜¯æœ€ç»ˆç‰ˆæœ¬ã€‚å®ƒæœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š

- ç”¨äºå¼€å‘ã€æµ‹è¯•é˜¶æ®µï¼Œå¯ä»¥å¿«é€ŸéªŒè¯åŠŸèƒ½æ˜¯å¦æ­£å¸¸
- åŒ…å« `beta` æ ‡ç­¾
- ä¸åˆ›å»º `git tag`
- ç‰ˆæœ¬å·æ ¼å¼: `0.0.0-beta-timestamp`

### æ­£å¼åŒ…å‘åŒ…

æ­£å¼åŒ…æ˜¯æŒ‡å‘åŒ…çš„åŒ…æ˜¯æ­£å¼åŒ…ï¼Œåœ¨ç»å¸¸æµ‹è¯•åï¼Œå¯ä»¥å‘å¸ƒæ­£å¼åŒ…ï¼Œä¾›ç”¨æˆ·ä½¿ç”¨ã€‚å®ƒæœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š

- ç”¨äºç”Ÿäº§ç¯å¢ƒ
- åˆ›å»ºæ­£å¼çš„ `git tag`
- ç‰ˆæœ¬å·æ ¼å¼: `x.x.x`

## å‘åŒ…æµç¨‹

### å¿«ç…§åŒ…å‘åŒ…æµç¨‹

- åˆ›å»ºå˜æ›´é›†

```bash
pnpm changeset
```

- æäº¤ä»£ç åˆ° `feat` åˆ†æ”¯

```bash
git add . && git commit -m "chore: add changeset"
git push
```

- åœ¨ gitlab CI ä¸­æ‰§è¡Œå‘åŒ…æµç¨‹

  - **å¯é€‰**: æ‰‹åŠ¨è§¦å‘ `check-releases-packages` æŸ¥çœ‹å¾…å‘å¸ƒçš„åŒ…

  - **æ‰‹åŠ¨è§¦å‘**: `snapshot-publish:pkg` æ‰§è¡Œå‘å¸ƒå‘å¸ƒåä¼šå¸¦æœ‰ `beta` tagï¼Œä¸åˆ›å»º `git tag`

### æ­£å¼åŒ…å‘åŒ…æµç¨‹

- åˆ›å»ºå˜æ›´é›†

```bash
pnpm changeset
git add . && git commit -m "chore: add changeset"
git push

```

- `feat` åˆ†æ”¯åˆå¹¶åˆ° `master` åˆ†æ”¯

```bash
# åˆ›å»º merge request: feat -> master
# ç­‰å¾… review é€šè¿‡ååˆå¹¶åˆ° master
# æ­¤æ—¶å˜æ›´é›†ä¼šéšç€ä»£ç ä¸€èµ·åˆå…¥ master
```

- åœ¨ gitlab CI ä¸­æ‰§è¡Œå‘åŒ…æµç¨‹

  - **å¯é€‰**: æ‰‹åŠ¨è§¦å‘ `check-releases-packages` æŸ¥çœ‹å¾…å‘å¸ƒçš„åŒ…

  - **æ‰‹åŠ¨è§¦å‘**: `production-publish:pkg` æ‰§è¡Œå‘å¸ƒ

## CI ä»»åŠ¡è¯´æ˜

- `check-releases-packages`

  - ä½œç”¨: æ£€æŸ¥å¹¶å±•ç¤ºå¾…å‘å¸ƒçš„åŒ…
  - è§¦å‘æ–¹å¼: æ‰‹åŠ¨
  - æ”¯æŒåˆ†æ”¯: `feat/*`, `develop`, `master`
  - è¾“å‡ºæ ¼å¼: ğŸ“¦ åŒ…å => æ–°ç‰ˆæœ¬å·

```bash
check-releases-packages:
  stage: publish
  when: manual
  only:
    - /^feat\/.*$/
    - develop
    - master
  script:
    - |
      OUTPUT=$(pnpm exec zx ./scripts/check-releases.mjs)
      if [[ -n "$OUTPUT" ]]; then
        echo "â­ï¸ å³å°†å‘å¸ƒä»¥ä¸‹ packages:"
        echo "$OUTPUT"
      else
        echo "No packages to publish"
        exit 1
      fi
```

- `snapshot-publish:pkg`

  - ä½œç”¨: å‘å¸ƒå¿«ç…§åŒ…
  - è§¦å‘æ–¹å¼: æ‰‹åŠ¨
  - æ”¯æŒåˆ†æ”¯: `feat/*`, `develop`

```bash
snapshot-publish:pkg:
  stage: publish
  when: manual
  only:
    - /^feat\/.*$/
    - develop
  script:
    - pnpm exec zx ./scripts/build.mjs
    - |
      if [[ -n "$(pnpm exec zx ./scripts/check-releases.mjs)" ]]; then
        pnpm exec changeset version --snapshot beta
        pnpm exec changeset publish --tag beta --no-git-tag --snapshot
      else
        echo "No packages to publish"
      fi
  artifacts:
    paths:
      - packages/*/dist
```

- `production-publish:pkg`
  - ä½œç”¨: å‘å¸ƒæ­£å¼ç‰ˆæœ¬
  - è§¦å‘æ–¹å¼: æ‰‹åŠ¨
  - æ”¯æŒåˆ†æ”¯: `master`
  - å‰ç½®æ¡ä»¶: éœ€è¦å…ˆæ‰§è¡Œ `check-releases-packages`
  - æ‰§è¡Œæ­¥éª¤: é…ç½® git ç”¨æˆ·ä¿¡æ¯æ„å»ºåŒ…æ›´æ–°ç‰ˆæœ¬å·å‘å¸ƒåŒ…æäº¤ç‰ˆæœ¬æ›´æ–°åˆ›å»º git tag

```bash
production-publish:pkg:
  stage: publish
  needs: ['check-releases-packages']
  when: manual
  only:
    - master
  script:
    - |
      OUTPUT=$(pnpm exec zx ./scripts/check-releases.mjs)
      if [[ -n "$OUTPUT" ]]; then
        git config --global user.email "${APP_BOT_ACCESS_NAME}"
        git config --global user.name "${APP_BOT_ACCESS_NAME}"
        pnpm exec zx ./scripts/build.mjs
        pnpm exec changeset version
        pnpm exec changeset publish
        pnpm exec zx ./scripts/commit-version.mjs
      fi
  artifacts:
    paths:
      - packages/*/dist
```
