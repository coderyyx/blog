# 企业级发包流程

## 背景

在企业级项目中，发包很常见，它可能是一个基础包或是某个功能插件，但都避免不了新增功能或者 `bugfix`，这就涉及到如何快速发布测试包以及正式包。本文主要介绍一种通用的发包流程，可以满足大部分场景。

## 前言

本文详细介绍 Monorepo 项目的发包流程和操作步骤。主要基于 [changesets](https://github.com/changesets/changesets) 实现。
**单仓库也适用于本方案**

## 发包类型

项目支持两种发包类型：

- 快照包发包
- 正式包发包

### 快照包发包

快照包是指发包的包是 `beta` 版本，使用场景主要是开发、测试阶段，可以快速验证功能是否正常，不是最终版本。它有如下特点：

- 用于开发、测试阶段，可以快速验证功能是否正常
- 包含 `beta` 标签
- 不创建 `git tag`
- 版本号格式: `0.0.0-beta-timestamp`

### 正式包发包

正式包即生产包，在经常测试稳定后可以发布正式包，供用户使用。它有如下特点：

- 用于生产环境
- 创建正式的 `git tag`
- 版本号格式: `x.x.x`

## 发包流程

### 快照包发包流程

- 创建变更集

```bash
pnpm changeset
```

<img width="759" height="308" alt="image" src="https://github.com/user-attachments/assets/04eb04d0-8a67-46a1-a44d-4927bbb3934b" />

- 提交代码到 `feat` 分支

```bash
git add . && git commit -m "chore: add changeset"
git push
```

- 在 gitlab CI 中执行发包流程

  - **可选**: 手动触发 `check-releases-packages` 查看待发布的包

  - **手动触发**: `snapshot-publish:pkg` 执行发布发布后会带有 `beta` tag，不创建 `git tag`

### 正式包发包流程

- 创建变更集

```bash
pnpm changeset
git add . && git commit -m "chore: add changeset"
git push

```

- `feat` 分支合并到 `master` 分支

```bash
# 创建 merge request: feat -> master
# 等待 review 通过后合并到 master
# 此时变更集会随着代码一起合入 master
```

- 在 gitlab CI 中执行发包流程

  - **可选**: 手动触发 `check-releases-packages` 查看待发布的包

  - **手动触发**: `production-publish:pkg` 执行发布

## CI 任务说明

- `check-releases-packages`

  - 作用: 检查并展示待发布的包
  - 触发方式: 手动
  - 支持分支: `feat/*`, `develop`, `master`
  - 输出格式: 📦 包名 => 新版本号

```bash
check-releases-packages:
  stage: publish
  when: manual
  only:
    - /^feat\/.*$/
    - develop
    - master
  script:
    - |
      OUTPUT=$(pnpm exec zx ./scripts/check-releases.mjs)
      if [[ -n "$OUTPUT" ]]; then
        echo "⭐️ 即将发布以下 packages:"
        echo "$OUTPUT"
      else
        echo "No packages to publish"
        exit 1
      fi
```

- `snapshot-publish`

  - 作用: 发布快照包
  - 触发方式: 手动
  - 支持分支: `feat/*`, `develop`

```bash
snapshot-publish:
  stage: publish
  when: manual
  only:
    - /^feat\/.*$/
    - develop
  script:
    - pnpm exec zx ./scripts/build.mjs
    - |
      if [[ -n "$(pnpm exec zx ./scripts/check-releases.mjs)" ]]; then
        pnpm exec changeset version --snapshot beta
        pnpm exec changeset publish --tag beta --no-git-tag --snapshot
      else
        echo "No packages to publish"
      fi
  artifacts:
    paths:
      - packages/*/dist
```

- `production-publish`
  - 作用: 发布正式版本
  - 触发方式: 手动
  - 支持分支: `master`
  - 前置条件: 需要先执行 `check-releases-packages`
  - 执行步骤: 配置 git 用户信息构建包更新版本号发布包提交版本更新创建 git tag

```bash
production-publish:
  stage: publish
  needs: ['check-releases-packages']
  when: manual
  only:
    - master
  script:
    - |
      OUTPUT=$(pnpm exec zx ./scripts/check-releases.mjs)
      if [[ -n "$OUTPUT" ]]; then
        git config --global user.email "${APP_BOT_ACCESS_NAME}"
        git config --global user.name "${APP_BOT_ACCESS_NAME}"

        echo "📋 检测到需要发布的包："
        echo "$OUTPUT"
        echo ""
        echo "📦 构建包..."
        pnpm exec zx ./scripts/build.mjs

        echo "🔖 更新版本..."
        pnpm exec changeset version

        echo "🚀 发布包..."
        pnpm exec changeset publish

        echo "💾 提交版本变更..."
        pnpm exec zx ./scripts/commit-version.mjs

        echo "✅ 生产环境包发布完成"

      fi
  artifacts:
    paths:
      - packages/*/dist
```

## 引用

上述 ci 过程中文件 `scripts/check-releases.mjs` 和 `scripts/commit-version.mjs` 是通用的，可以参考以下文件：

- [check-releases.mjs](https://github.com/coderyyx/base-monorepo/tree/main/scripts/check-releases.mjs)
- [commit-version.mjs](https://github.com/coderyyx/base-monorepo/tree/main/scripts/commit-version.mjs)
- [build.mjs](https://github.com/coderyyx/base-monorepo/tree/main/scripts/build.mjs)

**注意**： 单包参考是不需要 `build.mjs` 文件的。这个执行单包的打包命令即可

## `changeset` 相关命令解析

### `pnpm changeset`

`changeset` 是 `changesets` 的命令行工具，用于创建、编辑和发布变更集。

```json
"scripts": {
    "changeset": "changeset"
  }

```

### `changeset version --snapshot beta`

应用更改集，但不是使用下一个版本，而是将所有版本设置为 `0.0.0-beta-THE_TIME_YOU_DID_THIS`。可以自定义 `beta` 标签。
详细参考 [changeset version](https://github.com/changesets/changesets/blob/main/docs/snapshot-releases.md#versioning-your-packages)

### `changeset publish --tag beta --no-git-tag --snapshot`

**发布快照包**，运行 `changeset version --snapshot beta` 命令后，可以使用 `changeset publish --tag beta` 命令发布包。通过使用 `--tag` 标记，你将不会把它添加到 npm 上的 `latest` 标记中。这一点非常重要，因为如果不加入标记，使用 `pnpm add your-package-name` 安装包的人会安装快照版本。

运行 `changeset publish --no-git-tag` 时，changesets 会跳过为已发布的快照包创建 git 标签。

详细参考 [changeset publish](https://github.com/changesets/changesets/blob/main/docs/snapshot-releases.md#publishing-your-packages)

### `changeset version`

### `changeset publish`

上述两个命令是配套使用的，用于发布生产包。

## 结语

这篇文章详细介绍了一套基于 `changesets` 的企业级 `Monorepo` 项目发包流程，适用于多包管理和单包项目。

这套流程特别适合：

- 企业级 Monorepo 项目
- 需要频繁发包的团队
- 对版本管理要求严格的项目
- 需要区分测试版本和生产版本的场景

提供了一个完整、可靠的企业级发包解决方案，既保证了发布的安全性，又提高了发包效率。
