# ä¼ä¸šçº§å‘åŒ…æµç¨‹

## èƒŒæ™¯

åœ¨ä¼ä¸šçº§é¡¹ç›®ä¸­ï¼Œå‘åŒ…å¾ˆå¸¸è§ï¼Œå®ƒå¯èƒ½æ˜¯ä¸€ä¸ªåŸºç¡€åŒ…æˆ–æ˜¯æŸä¸ªåŠŸèƒ½æ’ä»¶ï¼Œä½†éƒ½é¿å…ä¸äº†æ–°å¢åŠŸèƒ½æˆ–è€… `bugfix`ï¼Œè¿™å°±æ¶‰åŠåˆ°å¦‚ä½•å¿«é€Ÿå‘å¸ƒæµ‹è¯•åŒ…ä»¥åŠæ­£å¼åŒ…ã€‚æœ¬æ–‡ä¸»è¦ä»‹ç»ä¸€ç§é€šç”¨çš„å‘åŒ…æµç¨‹ï¼Œå¯ä»¥æ»¡è¶³å¤§éƒ¨åˆ†åœºæ™¯ã€‚

## å‰è¨€

æœ¬æ–‡è¯¦ç»†ä»‹ç» Monorepo é¡¹ç›®çš„å‘åŒ…æµç¨‹å’Œæ“ä½œæ­¥éª¤ã€‚ä¸»è¦åŸºäº [changesets](https://github.com/changesets/changesets) å®ç°ã€‚
**å•ä»“åº“ä¹Ÿé€‚ç”¨äºæœ¬æ–¹æ¡ˆ**

## å‘åŒ…ç±»å‹

é¡¹ç›®æ”¯æŒä¸¤ç§å‘åŒ…ç±»å‹ï¼š

- å¿«ç…§åŒ…å‘åŒ…
- æ­£å¼åŒ…å‘åŒ…

### å¿«ç…§åŒ…å‘åŒ…

å¿«ç…§åŒ…æ˜¯æŒ‡å‘åŒ…çš„åŒ…æ˜¯ `beta` ç‰ˆæœ¬ï¼Œä½¿ç”¨åœºæ™¯ä¸»è¦æ˜¯å¼€å‘ã€æµ‹è¯•é˜¶æ®µï¼Œå¯ä»¥å¿«é€ŸéªŒè¯åŠŸèƒ½æ˜¯å¦æ­£å¸¸ï¼Œä¸æ˜¯æœ€ç»ˆç‰ˆæœ¬ã€‚å®ƒæœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š

- ç”¨äºå¼€å‘ã€æµ‹è¯•é˜¶æ®µï¼Œå¯ä»¥å¿«é€ŸéªŒè¯åŠŸèƒ½æ˜¯å¦æ­£å¸¸
- åŒ…å« `beta` æ ‡ç­¾
- ä¸åˆ›å»º `git tag`
- ç‰ˆæœ¬å·æ ¼å¼: `0.0.0-beta-timestamp`

### æ­£å¼åŒ…å‘åŒ…

æ­£å¼åŒ…å³ç”Ÿäº§åŒ…ï¼Œåœ¨ç»å¸¸æµ‹è¯•ç¨³å®šåå¯ä»¥å‘å¸ƒæ­£å¼åŒ…ï¼Œä¾›ç”¨æˆ·ä½¿ç”¨ã€‚å®ƒæœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š

- ç”¨äºç”Ÿäº§ç¯å¢ƒ
- åˆ›å»ºæ­£å¼çš„ `git tag`
- ç‰ˆæœ¬å·æ ¼å¼: `x.x.x`

## å‘åŒ…æµç¨‹

### å¿«ç…§åŒ…å‘åŒ…æµç¨‹

- åˆ›å»ºå˜æ›´é›†

```bash
pnpm changeset
```

<img width="759" height="308" alt="image" src="https://github.com/user-attachments/assets/04eb04d0-8a67-46a1-a44d-4927bbb3934b" />

- æäº¤ä»£ç åˆ° `feat` åˆ†æ”¯

```bash
git add . && git commit -m "chore: add changeset"
git push
```

- åœ¨ gitlab CI ä¸­æ‰§è¡Œå‘åŒ…æµç¨‹

  - **å¯é€‰**: æ‰‹åŠ¨è§¦å‘ `check-releases-packages` æŸ¥çœ‹å¾…å‘å¸ƒçš„åŒ…

  - **æ‰‹åŠ¨è§¦å‘**: `snapshot-publish:pkg` æ‰§è¡Œå‘å¸ƒå‘å¸ƒåä¼šå¸¦æœ‰ `beta` tagï¼Œä¸åˆ›å»º `git tag`

### æ­£å¼åŒ…å‘åŒ…æµç¨‹

- åˆ›å»ºå˜æ›´é›†

```bash
pnpm changeset
git add . && git commit -m "chore: add changeset"
git push

```

- `feat` åˆ†æ”¯åˆå¹¶åˆ° `master` åˆ†æ”¯

```bash
# åˆ›å»º merge request: feat -> master
# ç­‰å¾… review é€šè¿‡ååˆå¹¶åˆ° master
# æ­¤æ—¶å˜æ›´é›†ä¼šéšç€ä»£ç ä¸€èµ·åˆå…¥ master
```

- åœ¨ gitlab CI ä¸­æ‰§è¡Œå‘åŒ…æµç¨‹

  - **å¯é€‰**: æ‰‹åŠ¨è§¦å‘ `check-releases-packages` æŸ¥çœ‹å¾…å‘å¸ƒçš„åŒ…

  - **æ‰‹åŠ¨è§¦å‘**: `production-publish:pkg` æ‰§è¡Œå‘å¸ƒ

## CI ä»»åŠ¡è¯´æ˜

- `check-releases-packages`

  - ä½œç”¨: æ£€æŸ¥å¹¶å±•ç¤ºå¾…å‘å¸ƒçš„åŒ…
  - è§¦å‘æ–¹å¼: æ‰‹åŠ¨
  - æ”¯æŒåˆ†æ”¯: `feat/*`, `develop`, `master`
  - è¾“å‡ºæ ¼å¼: ğŸ“¦ åŒ…å => æ–°ç‰ˆæœ¬å·

```bash
check-releases-packages:
  stage: publish
  when: manual
  only:
    - /^feat\/.*$/
    - develop
    - master
  script:
    - |
      OUTPUT=$(pnpm exec zx ./scripts/check-releases.mjs)
      if [[ -n "$OUTPUT" ]]; then
        echo "â­ï¸ å³å°†å‘å¸ƒä»¥ä¸‹ packages:"
        echo "$OUTPUT"
      else
        echo "No packages to publish"
        exit 1
      fi
```

- `snapshot-publish`

  - ä½œç”¨: å‘å¸ƒå¿«ç…§åŒ…
  - è§¦å‘æ–¹å¼: æ‰‹åŠ¨
  - æ”¯æŒåˆ†æ”¯: `feat/*`, `develop`

```bash
snapshot-publish:
  stage: publish
  when: manual
  only:
    - /^feat\/.*$/
    - develop
  script:
    - pnpm exec zx ./scripts/build.mjs
    - |
      if [[ -n "$(pnpm exec zx ./scripts/check-releases.mjs)" ]]; then
        pnpm exec changeset version --snapshot beta
        pnpm exec changeset publish --tag beta --no-git-tag --snapshot
      else
        echo "No packages to publish"
      fi
  artifacts:
    paths:
      - packages/*/dist
```

- `production-publish`
  - ä½œç”¨: å‘å¸ƒæ­£å¼ç‰ˆæœ¬
  - è§¦å‘æ–¹å¼: æ‰‹åŠ¨
  - æ”¯æŒåˆ†æ”¯: `master`
  - å‰ç½®æ¡ä»¶: éœ€è¦å…ˆæ‰§è¡Œ `check-releases-packages`
  - æ‰§è¡Œæ­¥éª¤: é…ç½® git ç”¨æˆ·ä¿¡æ¯æ„å»ºåŒ…æ›´æ–°ç‰ˆæœ¬å·å‘å¸ƒåŒ…æäº¤ç‰ˆæœ¬æ›´æ–°åˆ›å»º git tag

```bash
production-publish:
  stage: publish
  needs: ['check-releases-packages']
  when: manual
  only:
    - master
  script:
    - |
      OUTPUT=$(pnpm exec zx ./scripts/check-releases.mjs)
      if [[ -n "$OUTPUT" ]]; then
        git config --global user.email "${APP_BOT_ACCESS_NAME}"
        git config --global user.name "${APP_BOT_ACCESS_NAME}"

        echo "ğŸ“‹ æ£€æµ‹åˆ°éœ€è¦å‘å¸ƒçš„åŒ…ï¼š"
        echo "$OUTPUT"
        echo ""
        echo "ğŸ“¦ æ„å»ºåŒ…..."
        pnpm exec zx ./scripts/build.mjs

        echo "ğŸ”– æ›´æ–°ç‰ˆæœ¬..."
        pnpm exec changeset version

        echo "ğŸš€ å‘å¸ƒåŒ…..."
        pnpm exec changeset publish

        echo "ğŸ’¾ æäº¤ç‰ˆæœ¬å˜æ›´..."
        pnpm exec zx ./scripts/commit-version.mjs

        echo "âœ… ç”Ÿäº§ç¯å¢ƒåŒ…å‘å¸ƒå®Œæˆ"

      fi
  artifacts:
    paths:
      - packages/*/dist
```

## å¼•ç”¨

ä¸Šè¿° ci è¿‡ç¨‹ä¸­æ–‡ä»¶ `scripts/check-releases.mjs` å’Œ `scripts/commit-version.mjs` æ˜¯é€šç”¨çš„ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹æ–‡ä»¶ï¼š

- [check-releases.mjs](https://github.com/coderyyx/base-monorepo/tree/main/scripts/check-releases.mjs)
- [commit-version.mjs](https://github.com/coderyyx/base-monorepo/tree/main/scripts/commit-version.mjs)
- [build.mjs](https://github.com/coderyyx/base-monorepo/tree/main/scripts/build.mjs)

**æ³¨æ„**ï¼š å•åŒ…å‚è€ƒæ˜¯ä¸éœ€è¦ `build.mjs` æ–‡ä»¶çš„ã€‚è¿™ä¸ªæ‰§è¡Œå•åŒ…çš„æ‰“åŒ…å‘½ä»¤å³å¯

## `changeset` ç›¸å…³å‘½ä»¤è§£æ

### `pnpm changeset`

`changeset` æ˜¯ `changesets` çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºåˆ›å»ºã€ç¼–è¾‘å’Œå‘å¸ƒå˜æ›´é›†ã€‚

```json
"scripts": {
    "changeset": "changeset"
  }

```

### `changeset version --snapshot beta`

åº”ç”¨æ›´æ”¹é›†ï¼Œä½†ä¸æ˜¯ä½¿ç”¨ä¸‹ä¸€ä¸ªç‰ˆæœ¬ï¼Œè€Œæ˜¯å°†æ‰€æœ‰ç‰ˆæœ¬è®¾ç½®ä¸º `0.0.0-beta-THE_TIME_YOU_DID_THIS`ã€‚å¯ä»¥è‡ªå®šä¹‰ `beta` æ ‡ç­¾ã€‚
è¯¦ç»†å‚è€ƒ [changeset version](https://github.com/changesets/changesets/blob/main/docs/snapshot-releases.md#versioning-your-packages)

### `changeset publish --tag beta --no-git-tag --snapshot`

**å‘å¸ƒå¿«ç…§åŒ…**ï¼Œè¿è¡Œ `changeset version --snapshot beta` å‘½ä»¤åï¼Œå¯ä»¥ä½¿ç”¨ `changeset publish --tag beta` å‘½ä»¤å‘å¸ƒåŒ…ã€‚é€šè¿‡ä½¿ç”¨ `--tag` æ ‡è®°ï¼Œä½ å°†ä¸ä¼šæŠŠå®ƒæ·»åŠ åˆ° npm ä¸Šçš„ `latest` æ ‡è®°ä¸­ã€‚è¿™ä¸€ç‚¹éå¸¸é‡è¦ï¼Œå› ä¸ºå¦‚æœä¸åŠ å…¥æ ‡è®°ï¼Œä½¿ç”¨ `pnpm add your-package-name` å®‰è£…åŒ…çš„äººä¼šå®‰è£…å¿«ç…§ç‰ˆæœ¬ã€‚

è¿è¡Œ `changeset publish --no-git-tag` æ—¶ï¼Œchangesets ä¼šè·³è¿‡ä¸ºå·²å‘å¸ƒçš„å¿«ç…§åŒ…åˆ›å»º git æ ‡ç­¾ã€‚

è¯¦ç»†å‚è€ƒ [changeset publish](https://github.com/changesets/changesets/blob/main/docs/snapshot-releases.md#publishing-your-packages)

### `changeset version`

### `changeset publish`

ä¸Šè¿°ä¸¤ä¸ªå‘½ä»¤æ˜¯é…å¥—ä½¿ç”¨çš„ï¼Œç”¨äºå‘å¸ƒç”Ÿäº§åŒ…ã€‚

## ç»“è¯­

è¿™ç¯‡æ–‡ç« è¯¦ç»†ä»‹ç»äº†ä¸€å¥—åŸºäº `changesets` çš„ä¼ä¸šçº§ `Monorepo` é¡¹ç›®å‘åŒ…æµç¨‹ï¼Œé€‚ç”¨äºå¤šåŒ…ç®¡ç†å’Œå•åŒ…é¡¹ç›®ã€‚

è¿™å¥—æµç¨‹ç‰¹åˆ«é€‚åˆï¼š

- ä¼ä¸šçº§ Monorepo é¡¹ç›®
- éœ€è¦é¢‘ç¹å‘åŒ…çš„å›¢é˜Ÿ
- å¯¹ç‰ˆæœ¬ç®¡ç†è¦æ±‚ä¸¥æ ¼çš„é¡¹ç›®
- éœ€è¦åŒºåˆ†æµ‹è¯•ç‰ˆæœ¬å’Œç”Ÿäº§ç‰ˆæœ¬çš„åœºæ™¯

æä¾›äº†ä¸€ä¸ªå®Œæ•´ã€å¯é çš„ä¼ä¸šçº§å‘åŒ…è§£å†³æ–¹æ¡ˆï¼Œæ—¢ä¿è¯äº†å‘å¸ƒçš„å®‰å…¨æ€§ï¼Œåˆæé«˜äº†å‘åŒ…æ•ˆç‡ã€‚
