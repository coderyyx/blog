# 企业级发包流程

## 背景

在企业级项目中，发包很常见，它可能是一个基础包或是某个功能插件，但都避免不了新增功能或者 `bugfix`，这就涉及到如何快速发布测试包以及正式包。本文主要介绍一种通用的发包流程，可以满足大部分场景。

## 前言

本文详细介绍 Monorepo 项目的发包流程和操作步骤。主要基于 [changesets](https://github.com/changesets/changesets) 实现。
**单仓库也适用于本方案**

## 发包类型

项目支持两种发包类型：

- 快照包发包
- 正式包发包

### 快照包发包

快照包是指发包的包是 `beta` 版本，使用场景主要是开发、测试阶段，可以快速验证功能是否正常，不是最终版本。它有如下特点：

- 用于开发、测试阶段，可以快速验证功能是否正常
- 包含 `beta` 标签
- 不创建 `git tag`
- 版本号格式: `0.0.0-beta-timestamp`

### 正式包发包

正式包是指发包的包是正式包，在经常测试后，可以发布正式包，供用户使用。它有如下特点：

- 用于生产环境
- 创建正式的 `git tag`
- 版本号格式: `x.x.x`

## 发包流程

### 快照包发包流程

- 创建变更集

```bash
pnpm changeset
```

- 提交代码到 `feat` 分支

```bash
git add . && git commit -m "chore: add changeset"
git push
```

- 在 gitlab CI 中执行发包流程

  - **可选**: 手动触发 `check-releases-packages` 查看待发布的包

  - **手动触发**: `snapshot-publish:pkg` 执行发布发布后会带有 `beta` tag，不创建 `git tag`

### 正式包发包流程

- 创建变更集

```bash
pnpm changeset
git add . && git commit -m "chore: add changeset"
git push

```

- `feat` 分支合并到 `master` 分支

```bash
# 创建 merge request: feat -> master
# 等待 review 通过后合并到 master
# 此时变更集会随着代码一起合入 master
```

- 在 gitlab CI 中执行发包流程

  - **可选**: 手动触发 `check-releases-packages` 查看待发布的包

  - **手动触发**: `production-publish:pkg` 执行发布

## CI 任务说明

- `check-releases-packages`

  - 作用: 检查并展示待发布的包
  - 触发方式: 手动
  - 支持分支: `feat/*`, `develop`, `master`
  - 输出格式: 📦 包名 => 新版本号

```bash
check-releases-packages:
  stage: publish
  when: manual
  only:
    - /^feat\/.*$/
    - develop
    - master
  script:
    - |
      OUTPUT=$(pnpm exec zx ./scripts/check-releases.mjs)
      if [[ -n "$OUTPUT" ]]; then
        echo "⭐️ 即将发布以下 packages:"
        echo "$OUTPUT"
      else
        echo "No packages to publish"
        exit 1
      fi
```

- `snapshot-publish:pkg`

  - 作用: 发布快照包
  - 触发方式: 手动
  - 支持分支: `feat/*`, `develop`

```bash
snapshot-publish:pkg:
  stage: publish
  when: manual
  only:
    - /^feat\/.*$/
    - develop
  script:
    - pnpm exec zx ./scripts/build.mjs
    - |
      if [[ -n "$(pnpm exec zx ./scripts/check-releases.mjs)" ]]; then
        pnpm exec changeset version --snapshot beta
        pnpm exec changeset publish --tag beta --no-git-tag --snapshot
      else
        echo "No packages to publish"
      fi
  artifacts:
    paths:
      - packages/*/dist
```

- `production-publish:pkg`
  - 作用: 发布正式版本
  - 触发方式: 手动
  - 支持分支: `master`
  - 前置条件: 需要先执行 `check-releases-packages`
  - 执行步骤: 配置 git 用户信息构建包更新版本号发布包提交版本更新创建 git tag

```bash
production-publish:pkg:
  stage: publish
  needs: ['check-releases-packages']
  when: manual
  only:
    - master
  script:
    - |
      OUTPUT=$(pnpm exec zx ./scripts/check-releases.mjs)
      if [[ -n "$OUTPUT" ]]; then
        git config --global user.email "${APP_BOT_ACCESS_NAME}"
        git config --global user.name "${APP_BOT_ACCESS_NAME}"
        pnpm exec zx ./scripts/build.mjs
        pnpm exec changeset version
        pnpm exec changeset publish
        pnpm exec zx ./scripts/commit-version.mjs
      fi
  artifacts:
    paths:
      - packages/*/dist
```
